#INFO: **** input file is /home/max/git/pyscf/pyscf/embcc/test/00-simple_cisd.py ****
#!/usr/bin/env python
#
# Author: Qiming Sun <osirpt.sun@gmail.com>
#

'''
A simple example to run CISD calculation.
'''
import numpy as np

import pyscf
import pyscf.scf
import pyscf.ci

mol = pyscf.M(
    atom = 'H 0 0 0; H 0 0 0.74',
    basis = 'ccpvdz',
    verbose=4)

mf = pyscf.scf.RHF(mol)
mf.run()
cc = pyscf.ci.CISD(mf)
cc.run()
print('RCISD correlation energy', cc.e_corr)

C0, C1 ,C2 = cc.cisdvec_to_amplitudes(cc.ci)
print(C0.shape)
print(C1.shape)
print(C2.shape)


print(C0)


a = cc.get_frozen_mask()
o = cc.mo_occ[a] > 0
v = cc.mo_occ[a] == 0
# Projector to local, occupied region
S = mf.get_ovlp()
C = cc.mo_coeff[:,a]

eris = cc.ao2mo()
F = eris.fock[o][:,v]
print(F.shape)
e1 = 2*np.sum(F * C1)
print(e1)


C21 = C2 + 2*np.einsum('ia,jb->ijab', C1, C1, optimize=True)
#C21 = C2

e2 = 2*np.einsum('ijab,iabj', C21, eris.ovvo, optimize=True)
e2 -=  np.einsum('ijab,jabi', C21, eris.ovvo, optimize=True)
print(e2)

e_ccsd = e1+e2

print("%e" % (e_ccsd - cc.e_corr))





#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='zombie', release='4.4.0-174-generic', version='#204-Ubuntu SMP Wed Jan 29 06:41:01 UTC 2020', machine='x86_64', processor='x86_64')  Threads 8
Python 3.5.2 (default, Apr 16 2020, 17:47:17) 
[GCC 5.4.0 20160609]
numpy 1.15.4  scipy 1.1.0
Date: Fri May 29 12:28:05 2020
PySCF version 1.7.2
PySCF path  /home/max/git/pyscf/pyscf
GIT ORIG_HEAD cb0486ef192e5588945b2d08b61c3a8f7c1e5595
GIT HEAD      ref: refs/heads/master
GIT master branch  954037719c0503d24475009431087f39efa2fb90

[ENV] PYSCFHOME /home/max/git/pyscf
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 2
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 H      0.000000000000   0.000000000000   0.740000000000 AA    0.000000000000   0.000000000000   1.398397332178 Bohr

nuclear repulsion = 0.715104339081081
number of shells = 6
number of NR pGTOs = 14
number of NR cGTOs = 10
basis = ccpvdz
ecp = {}
CPU time:         0.63


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /home/max/git/pyscf/pyscf/embcc/test/tmp82udszlu
max_memory 4000 MB (current use 70 MB)
Set gradient conv threshold to 3.16228e-05
init E= -0.812083679939728
  HOMO = -0.554565732564959  LUMO = 0.155207455491935
cycle= 1 E= -1.12773421671327  delta_E= -0.316  |g|= 0.0451  |ddm|= 0.706
  HOMO = -0.599776376507856  LUMO = 0.193233599759234
cycle= 2 E= -1.12867333647629  delta_E= -0.000939  |g|= 0.00705  |ddm|= 0.0427
  HOMO = -0.592660120519732  LUMO = 0.197294465909792
cycle= 3 E= -1.12870002499144  delta_E= -2.67e-05  |g|= 0.000396  |ddm|= 0.00918
  HOMO = -0.592406024301199  LUMO = 0.197439341367715
cycle= 4 E= -1.12870009355148  delta_E= -6.86e-08  |g|= 3.04e-06  |ddm|= 0.000564
  HOMO = -0.592410985464229  LUMO = 0.197440055428591
cycle= 5 E= -1.12870009355644  delta_E= -4.96e-12  |g|= 7.94e-10  |ddm|= 4.19e-06
  HOMO = -0.592410986074831  LUMO = 0.19744005570797
Extra cycle  E= -1.12870009355644  delta_E= 8.88e-16  |g|= 1.46e-10  |ddm|= 9.62e-10
converged SCF energy = -1.12870009355644

******** <class 'pyscf.ci.cisd.RCISD'> ********
CISD nocc = 1, nmo = 10
max_cycle = 50
direct = 0
conv_tol = 1e-09
max_cycle = 50
max_space = 12
lindep = 0
nroots = 1
max_memory 4000 MB (current use 76 MB)
Init t2, MP2 energy = -0.0263715576349988
RCISD converged
E(RCISD) = -1.16337449031821  E_corr = -0.03467439676177027
